#Triggering update - dummy change
name: Databricks CI/CD

on:
  push:
    paths:
      - 'notebooks/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/ci_pipeline.yml'
  
  schedule:
    - cron: '0 9 * * *'  

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install azure-identity azure-keyvault-secrets

    - name: Run unit tests
      run: |
        pytest tests

    - name: Install Databricks CLI
      run: pip install databricks-cli

    - name: Configure Databricks CLI using Azure Key Vault
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      run: |
        python scripts/set_config.py
      
    - name: Archive pipeline logs to Azure Blob
      run: |
        mkdir -p logs
        echo "Pipeline executed on: $(date)" >> logs/pipeline_log.txt
        echo "Workflow finished." >> logs/pipeline_log.txt
        
        echo "Installing Azure CLI..."
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

        echo "Uploading log to Azure Blob..."
        az storage blob upload \
          --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
          --account-key ${{ secrets.AZURE_STORAGE_KEY1 }} \
          --container-name prem-csv-logs-container \
          --file logs/pipeline_log.txt \
          --name pipeline_log_$(date +%s).txt


    - name: Upload notebook to Databricks Workspace
      env:
        DATABRICKS_CONFIG_FILE: /home/runner/.databricks/config
      run: |
        databricks workspace import notebooks/ingest_data.py /Users/rajnees1173@outlook.com/ingest_data -l PYTHON -f SOURCE

    - name: Run Databricks Job
      env:
        DATABRICKS_CONFIG_FILE: /home/runner/.databricks/config
      run: |
        databricks jobs run-now --job-id 688315178708804 || echo "Manual job trigger or add job creation logic"
